{% extends "layout.html" %}
{% block title %}Nhật ký Hoạt động{% endblock %}

{% block content %}
<!-- Activity Log Configuration -->
{% set ACTION_BADGES = {
    'login': {'class': 'text-bg-success', 'icon': 'fa-right-to-bracket', 'label': 'Login'},
    'logout': {'class': 'text-bg-secondary', 'icon': 'fa-right-from-bracket', 'label': 'Logout'},
    'blocked': {'class': 'text-bg-warning', 'icon': 'fa-user-lock', 'label': 'Block User'},
    'approved': {'class': 'text-bg-info', 'icon': 'fa-user-check', 'label': 'Approve User'},
    'unblocked': {'class': 'text-bg-success', 'icon': 'fa-lock-open', 'label': 'Unblock User'},
    'delete': {'class': 'text-bg-danger', 'icon': 'fa-trash', 'label': 'Delete Item'},
    'create folder': {'class': 'text-bg-primary', 'icon': 'fa-folder-plus', 'label': 'Create Folder'},
    'save file': {'class': 'text-bg-primary', 'icon': 'fa-save', 'label': 'Save File'},
    'open file': {'class': 'text-bg-secondary', 'icon': 'fa-file-lines', 'label': 'Open File'},
    'rename': {'class': 'text-bg-info', 'icon': 'fa-i-cursor', 'label': 'Rename Item'},
    'upload': {'class': 'text-bg-primary', 'icon': 'fa-upload', 'label': 'Upload File'}
} %}

<div class="container py-4">
    <!-- Header Section -->
    <header class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="mb-0">
            <i class="fa-solid fa-clipboard-list me-2"></i>
            Nhật ký Hoạt động Hệ thống
        </h3>
        <a href="{{ url_for('admin_manage') }}" class="btn btn-secondary btn-sm">
            <i class="fa-solid fa-arrow-left me-1"></i>
            Quay lại Quản lý
        </a>
    </header>

    <!-- Activity Log Table -->
    <div class="card bg-dark border-secondary shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive" style="max-height: 75vh; overflow-y: auto;">
                <table class="table table-dark table-hover align-middle mb-0">
                    <thead class="sticky-top bg-dark">
                        <tr>
                            <th scope="col" class="ps-3">Thời gian</th>
                            <th scope="col">Người thực hiện</th>
                            <th scope="col">Hành động</th>
                            <th scope="col">Chi tiết</th>
                            <th scope="col" class="pe-3">IP Address</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for log in logs %}
                        {% set action_parts = log.action.split(':', 1) %}
                        {% set action_type = action_parts[0].strip().lower() %}
                        {% set action_details = action_parts[1].strip() if action_parts|length > 1 else '' %}
                        {% set badge_config = ACTION_BADGES.get(action_type, {'class': 'text-bg-dark', 'icon': 'fa-cog', 'label': action_parts[0].strip()}) %}
                        
                        <tr>
                            <td class="ps-3">
                                <time datetime="{{ log.timestamp.isoformat() }}" class="text-muted small">
                                    {{ log.timestamp.strftime('%d/%m/%Y %H:%M') }}
                                </time>
                            </td>
                            <td>
                                <strong class="text-light">{{ log.username }}</strong>
                            </td>
                            <td>
                                <span class="badge {{ badge_config.class }}">
                                    <i class="fa-solid {{ badge_config.icon }} me-1"></i>
                                    {{ badge_config.label }}
                                </span>
                            </td>
                            <td>
                                {% if action_details %}
                                <small class="text-muted text-break">{{ action_details }}</small>
                                {% else %}
                                <span class="text-muted">—</span>
                                {% endif %}
                            </td>
                            <td class="pe-3">
                                <code class="text-muted small">{{ log.ip_address }}</code>
                            </td>
                        </tr>
                        {% else %}
                        <!-- Empty State -->
                        <tr>
                            <td colspan="5" class="text-center py-5">
                                <div class="text-muted">
                                    <i class="fa-solid fa-inbox fa-3x mb-3 opacity-50"></i>
                                    <p class="mb-0 fs-6">Chưa có hoạt động nào được ghi lại</p>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Footer Info -->
        {% if logs %}
        <div class="card-footer bg-dark border-secondary text-muted text-center py-2">
            <small>
                <i class="fa-solid fa-info-circle me-1"></i>
                Hiển thị {{ logs|length }} hoạt động gần nhất
            </small>
        </div>
        {% endif %}
    </div>
</div>

<!-- Custom Styles -->
<style>
.table-responsive {
    scrollbar-width: thin;
    scrollbar-color: #6c757d #343a40;
}

.table-responsive::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

.table-responsive::-webkit-scrollbar-track {
    background: #343a40;
}

.table-responsive::-webkit-scrollbar-thumb {
    background: #6c757d;
    border-radius: 4px;
}

.table-responsive::-webkit-scrollbar-thumb:hover {
    background: #8e959b;
}

.text-break {
    word-wrap: break-word;
    overflow-wrap: break-word;
}

.table > tbody > tr > td {
    vertical-align: middle;
    border-color: #495057;
}

.table > thead > tr > th {
    border-bottom: 2px solid #6c757d;
    font-weight: 600;
}

.badge {
    font-size: 0.75rem;
    padding: 0.4rem 0.6rem;
}

@media (max-width: 768px) {
    .table th:nth-child(4),
    .table td:nth-child(4) {
        display: none;
    }
    
    .table th:nth-child(5),
    .table td:nth-child(5) {
        display: none;
    }
}
</style>
{% endblock %}