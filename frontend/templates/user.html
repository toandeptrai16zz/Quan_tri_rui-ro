{% extends "layout.html" %}

{% block title %}CodeSpace IDE - {{ username }}{% endblock %}

{% block extra_head %}
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
    <style>
        body { overflow: hidden !important; user-select: none; }
        .content-wrapper { height: calc(100vh - 58px); padding: 0; overflow: hidden; display: flex; }
        .ide-container { display: flex; width: 100%; height: 100%; background-color: #0d1117; color: #e6edf3; font-family: 'Inter', sans-serif; }
        .file-panel { width: 280px; min-width: 200px; max-width: 40%; background: #161b22; display: flex; flex-direction: column; flex-shrink: 0; border-right: 1px solid #30363d; }
        .panel-header { padding: 12px 16px; font-weight: 600; color: #f0f6fc; display: flex; align-items: center; gap: 10px; font-size: 13px; text-transform: uppercase; border-bottom: 1px solid #30363d; flex-shrink: 0; }
        .panel-actions { margin-left: auto; display: flex; gap: 4px; }
        .panel-content { flex-grow: 1; overflow-y: auto; padding: 8px; }
        .resizer { width: 5px; background: #30363d; cursor: col-resize; flex-shrink: 0; transition: background 0.2s ease; }
        .resizer:hover { background: #58a6ff; }
        .main-panel { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .editor-header { display: flex; align-items: center; padding: 0 8px; background: #161b22; border-bottom: 1px solid #30363d; flex-shrink: 0; }
        .editor-tabs { display: flex; flex-grow: 1; }
        .editor-tab { background: transparent; border: none; color: #8b949e; padding: 10px 16px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 13px; border-bottom: 2px solid transparent; transition: all 0.2s ease; }
        .editor-tab:hover { background: #21262d; color: #e6edf3; }
        .editor-tab.active { color: #e6edf3; border-bottom-color: #58a6ff; }
        .editor-tab .close-icon { font-size: 12px; padding: 4px; border-radius: 4px; }
        .editor-tab .close-icon:hover { background: #444; }
        .editor-actions { padding-right: 8px; display: flex; align-items: center; gap: 8px; }
        .editor-container { flex-grow: 1; overflow: hidden; position: relative; }
        #editor { position: absolute; top: 0; right: 0; bottom: 0; left: 0; }
        #terminal-container { height: 240px; flex-shrink: 0; display: flex; flex-direction: column; background: #0d1117; }
        #terminal { width: 100%; flex-grow: 1; position: relative; }
        .xterm { padding: 8px; height: 100%; }
        .xterm .xterm-viewport { overflow-y: auto !important; }
        .xterm .xterm-screen { user-select: text !important; }
        .xterm-selection { background-color: rgba(88, 166, 255, 0.3) !important; }
        .file-tree, .file-tree ul { list-style: none; padding: 0; margin: 0; }
        .file-tree ul { padding-left: 18px; }
        .tree-item { display: flex; align-items: center; gap: 6px; padding: 6px 8px; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .tree-item:hover { background: #21262d; }
        .tree-item.is-selected { background: #005cc5; }
        .tree-chevron { width: 16px; text-align: center; transition: transform 0.2s ease; }
        .tree-item.is-folder.is-open > .tree-chevron { transform: rotate(90deg); }
        .tree-icon { width: 18px; }
        .tree-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .file-tree ul { display: none; }
        .file-tree li.is-open > ul { display: block; }
        .context-menu { position: fixed; background: #21262d; border: 1px solid #444; border-radius: 6px; box-shadow: 0 8px 16px rgba(0,0,0,0.3); z-index: 1000; min-width: 180px; padding: 4px; display: none; }
        .context-menu-item { padding: 8px 12px; color: #e6edf3; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 13px; border-radius: 4px; background: none; border: none; width: 100%; text-align: left; }
        .context-menu-item:hover { background: #58a6ff; }
        .context-menu-item.danger:hover { background: #da3633; }
        .context-menu-separator { height: 1px; background: #444; margin: 4px 0; }
        .context-menu-icon { width: 14px; text-align: center; }
        .btn-ide { background: #238636; color: white; border: 1px solid #339d4b; }
        .btn-ide:hover { background: #2da44e; }
        .btn-upload { background: #8b5cf6; color: white; border: 1px solid #9f7aea; }
        .btn-upload:hover { background: #9f7aea; }
        .file-btn { background: none; border: none; color: #8b949e; padding: 4px 6px; border-radius: 4px; cursor: pointer; }
        .file-btn:hover { background: #30363d; color: #e6edf3; }
        .fa-spin { animation: fa-spin 1s infinite linear; }
        @keyframes fa-spin { to { transform: rotate(360deg); } }
        .resizer-horizontal { height: 5px; background: #30363d; cursor: row-resize; flex-shrink: 0; transition: background 0.2s ease; }
        .resizer-horizontal:hover { background: #58a6ff; }
        .main-panel.terminal-hidden #terminal-container,
        .main-panel.terminal-hidden .resizer-horizontal,
        .main-panel.terminal-hidden #compile-output-container { display: none; }
        .terminal-header { background: #161b22; padding: 4px 10px; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #30363d; flex-shrink: 0; }
        .terminal-title { font-size: 13px; font-weight: 500; color: #8b949e; text-transform: uppercase; }
        .terminal-actions { margin-left: auto; display: flex; gap: 4px; }
        .terminal-btn { background: none; border: none; color: #8b949e; padding: 2px 5px; border-radius: 4px; cursor: pointer; font-size: 12px; transition: all 0.2s ease; }
        .terminal-btn:hover { background: #30363d; color: #e6edf3; }
        .terminal-btn:active { background: #21262d; }
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
        .toast { margin-bottom: 10px; max-width: 350px; }
        #compile-output-container { flex-shrink: 0; max-height: 40%; overflow-y: auto; border-bottom: 1px solid #30363d; }
        .compile-output { background: #1e1e1e; color: #d4d4d4; border-radius: 6px; margin: 8px; overflow: hidden; border: 1px solid #30363d; font-family: 'JetBrains Mono', monospace; font-size: 12px; }
        .compile-result { margin: 0; border-radius: 6px; overflow: hidden; }
        .compile-result.success { border-left: 4px solid #28a745; }
        .compile-result.error { border-left: 4px solid #dc3545; }
        .result-header { padding: 12px 16px; font-weight: bold; display: flex; align-items: center; gap: 8px; font-size: 14px; }
        .result-header.success { background: linear-gradient(135deg, #1a3d2e, #2d5a45); color: #4ade80; }
        .result-header.error { background: linear-gradient(135deg, #3d1a1a, #5a2d2d); color: #f87171; }
        .error-analysis { background: #161b22; border-top: 1px solid #30363d; padding: 16px; }
        .errors-section h4, .warnings-section h4 { margin: 0 0 12px 0; font-size: 13px; display: flex; align-items: center; gap: 6px; color: #f87171; }
        .warnings-section h4 { color: #fbbf24; }
        .error-list, .warning-list { display: flex; flex-direction: column; gap: 8px; }
        .error-item, .warning-item { border: 1px solid #30363d; border-radius: 6px; padding: 12px; background: #0d1117; transition: all 0.2s ease; cursor: pointer; }
        .error-item:hover, .warning-item:hover { background: #161b22; border-color: #58a6ff; }
        .error-item { border-left: 4px solid #dc3545; }
        .warning-item { border-left: 4px solid #fbbf24; }
        .error-info, .warning-info { display: flex; align-items: center; gap: 12px; margin-bottom: 6px; font-size: 11px; }
        .error-number, .warning-number { background: #6c757d; color: white; padding: 2px 8px; border-radius: 12px; font-weight: bold; min-width: 20px; text-align: center; }
        .file-info { color: #8b949e; font-family: 'JetBrains Mono', monospace; display: flex; align-items: center; gap: 4px; }
        .error-message, .warning-message { font-size: 12px; line-height: 1.4; color: #d4d4d4; margin-bottom: 4px; }
        .toggle-btn { background: #238636; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 11px; cursor: pointer; margin: 8px 16px; }
        .toggle-btn:hover { background: #2ea043; }
        .raw-output { padding: 16px; background: #0d1117; border-top: 1px solid #30363d; }
        .raw-output pre { margin: 0; font-size: 11px; line-height: 1.4; white-space: pre-wrap; color: #d4d4d4; }
    </style>
{% endblock %}

{% block content %}{% endblock %}

{% block scripts %}
    <div class="ide-container">
        <div class="file-panel" id="filePanel">
            <div class="panel-header">
                <i class="fas fa-folder-tree"></i>
                <span>Explorer</span>
                <div class="panel-actions">
                    <button class="file-btn" onclick="handleUploadClick()" title="Upload Files">
                        <i class="fa-solid fa-upload"></i>
                    </button>
                    <button class="file-btn" onclick="createNewItem('file')" title="New File">
                        <i class="fa-solid fa-file-plus"></i>
                    </button>
                    <button class="file-btn" onclick="createNewItem('folder')" title="New Folder">
                        <i class="fa-solid fa-folder-plus"></i>
                    </button>
                    <button class="file-btn" onclick="refreshRootFiles()" title="Refresh">
                        <i class="fa-solid fa-rotate" id="refreshIcon"></i>
                    </button>
                </div>
            </div>
            <div class="panel-content">
                <ul class="file-tree" id="file-tree-root"></ul>
            </div>
        </div>
        
        <div class="resizer" id="resizer"></div>
        
        <div class="main-panel" id="mainPanel">
            <div class="editor-header">
                <div class="editor-tabs" id="editorTabs"></div>
                <div class="editor-actions">
                    <button class="btn btn-sm btn-dark" onclick="toggleTerminal()" title="Bật/Tắt Terminal" style="border-color: #444;">
                        <i class="fa-solid fa-terminal"></i>
                    </button>
                    <span class="border-end" style="height: 20px;"></span>
                    <select id="boardSelector" class="form-select form-select-sm d-inline-block w-auto" style="background-color: #30363d; color: white; border-color: #444;">
                        <option value="arduino:avr:uno">Arduino Uno</option>
                        <option value="arduino:avr:nano">Arduino Nano (ATmega328P)</option>
                        <option value="esp8266:esp8266:nodemcuv2">ESP8266 (NodeMCU 1.0)</option>
                        <option value="esp32:esp32:esp32doit-devkit-v1">ESP32 Dev Module</option>
                    </select>
                    <button class="btn btn-sm btn-success" onclick="compileCode(event)">
                        <i class="fa-solid fa-cogs"></i>
                        <span>Biên dịch</span>
                    </button>
                    <button class="btn btn-sm btn-upload" onclick="uploadCode(event)">
                        <i class="fa-solid fa-upload"></i>
                        <span>Nạp code</span>
                    </button>
                    <button class="btn btn-sm btn-ide" onclick="saveCurrentFile()">
                        <i class="fa-solid fa-save"></i>
                        <span>Save</span>
                    </button>
                </div>
            </div>
            <div class="editor-container" id="editorContainer">
                <div id="editor"></div>
            </div>
            <div id="compile-output-container"></div>
            <div class="resizer-horizontal" id="resizerHorizontal"></div>
            <div id="terminal-container">
                <div class="terminal-header">
                    <span class="terminal-title">Terminal</span>
                    <div class="terminal-actions">
                        <button class="terminal-btn" onclick="copyFromTerminal()" title="Copy Selection (Ctrl+Shift+C)">
                            <i class="fa-solid fa-copy"></i>
                        </button>
                        <button class="terminal-btn" onclick="pasteToTerminal()" title="Paste (Ctrl+Shift+V)">
                            <i class="fa-solid fa-paste"></i>
                        </button>
                        <button class="terminal-btn" onclick="clearTerminal()" title="Clear Terminal">
                            <i class="fa-solid fa-ban"></i>
                        </button>
                        <button class="terminal-btn" onclick="scrollToTop()" title="Scroll to Top">
                            <i class="fa-solid fa-arrow-up"></i>
                        </button>
                        <button class="terminal-btn" onclick="scrollToBottom()" title="Scroll to Bottom">
                            <i class="fa-solid fa-arrow-down"></i>
                        </button>
                    </div>
                </div>
                <div id="terminal"></div>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>
    <div class="context-menu" id="contextMenu"></div>
    <input type="file" id="fileUploadInput" multiple hidden onchange="handleFileUpload(this.files)">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.33.0/ace.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.33.0/ext-language_tools.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.33.0/ext-modelist.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-web-links@0.9.0/lib/xterm-addon-web-links.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js"></script>

    <script>
        // DOM Elements Cache
        const DOM = {
            filePanel: document.getElementById('filePanel'),
            resizer: document.getElementById('resizer'),
            mainPanel: document.getElementById('mainPanel'),
            editorContainer: document.getElementById('editorContainer'),
            terminalContainer: document.getElementById('terminal-container'),
            resizerHorizontal: document.getElementById('resizerHorizontal'),
            editorTabs: document.getElementById('editorTabs'),
            fileTreeRoot: document.getElementById('file-tree-root'),
            refreshIcon: document.getElementById('refreshIcon'),
            contextMenu: document.getElementById('contextMenu'),
            saveButton: document.querySelector('.btn-ide span'),
            fileUploadInput: document.getElementById('fileUploadInput'),
            toastContainer: document.getElementById('toastContainer')
        };

        // Global State
        let editor, terminal, fitAddon, webLinksAddon, socket;
        let currentFile = null;
        const openFiles = new Map();
        let selectedTreeItem = null;
        let uploadPath = '.';
        const username = "{{ username }}";

        // Configuration
        const CONFIG = {
            editor: {
                theme: "ace/theme/tomorrow_night_eighties",
                fontSize: 14,
                fontFamily: 'JetBrains Mono, monospace'
            },
            terminal: {
                fontSize: 13,
                fontFamily: 'JetBrains Mono, monospace',
                scrollback: 10000
            },
            fileIcons: {
                js: 'fa-js', html: 'fa-html5', css: 'fa-css3-alt', py: 'fa-python',
                json: 'fa-brackets-curly', md: 'fa-markdown', sh: 'fa-terminal',
                dockerfile: 'fa-docker', ino: 'fa-microchip', cpp: 'fa-code',
                c: 'fa-code', h: 'fa-code'
            }
        };

        // Initialization
        document.addEventListener('DOMContentLoaded', initializeIDE);

        function initializeIDE() {
            setupEditor();
            setupTerminal();
            setupResizers();
            setupEventListeners();
            refreshRootFiles();
            openWelcomeTab();
            connectTerminalSocket();
        }

        // Editor Setup
        function setupEditor() {
            editor = ace.edit("editor");
            ace.require("ace/ext/language_tools");
            
            editor.setTheme(CONFIG.editor.theme);
            editor.session.setMode("ace/mode/javascript");
            editor.setFontSize(CONFIG.editor.fontSize);
            editor.setOptions({
                fontFamily: CONFIG.editor.fontFamily,
                enableLiveAutocompletion: true,
                enableBasicAutocompletion: true,
                showPrintMargin: false,
                wrap: true,
            });

            editor.on("change", handleEditorChange);
        }

        function handleEditorChange() {
            if (currentFile && openFiles.has(currentFile)) {
                const fileData = openFiles.get(currentFile);
                if (fileData.saved) {
                    fileData.saved = false;
                    updateTabAppearance(currentFile);
                    DOM.saveButton.textContent = 'Save*';
                }
            }
        }

        // Terminal Setup
        function setupTerminal() {
            terminal = new Terminal({
                cursorBlink: true,
                fontFamily: CONFIG.terminal.fontFamily,
                fontSize: CONFIG.terminal.fontSize,
                theme: { 
                    background: '#0d1117', 
                    foreground: '#d4d4d4', 
                    cursor: '#d4d4d4'
                },
                scrollback: CONFIG.terminal.scrollback,
                rightClickSelectsWord: true,
                allowTransparency: true
            });
            
            fitAddon = new FitAddon.FitAddon();
            webLinksAddon = new WebLinksAddon.WebLinksAddon();
            
            terminal.loadAddon(fitAddon);
            terminal.loadAddon(webLinksAddon);
            terminal.open(document.getElementById('terminal'));
            
            const viewport = terminal.element.querySelector('.xterm-viewport');
            if (viewport) viewport.style.overflowY = 'auto';
            
            fitAddon.fit();
            setupTerminalEventListeners();
        }

        function setupTerminalEventListeners() {
            terminal.attachCustomKeyEventHandler(handleTerminalKeyEvent);
            
            document.getElementById('terminal').addEventListener('contextmenu', (e) => {
                e.preventDefault();
                showTerminalContextMenu(e);
            });
        }

        function handleTerminalKeyEvent(e) {
            if (e.ctrlKey && e.shiftKey && e.type === 'keydown') {
                if (e.code === 'KeyC') {
                    e.preventDefault();
                    copyFromTerminal();
                    return false;
                }
                if (e.code === 'KeyV') {
                    e.preventDefault();
                    pasteToTerminal();
                    return false;
                }
            }
            return true;
        }

        // Resizer Setup
        function setupResizers() {
            setupVerticalResizer();
            setupHorizontalResizer();
        }

        function setupVerticalResizer() {
            let isResizing = false;
            
            const handleMouseMove = (e) => {
                if (!isResizing) return;
                const newWidth = Math.max(200, Math.min(window.innerWidth * 0.4, e.clientX));
                DOM.filePanel.style.width = `${newWidth}px`;
            };
            
            const handleMouseUp = () => {
                isResizing = false;
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
                resizeComponents();
            };
            
            DOM.resizer.addEventListener('mousedown', (e) => {
                e.preventDefault();
                isResizing = true;
                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);
            });
        }

        function setupHorizontalResizer() {
            let isResizing = false;
            
            const handleMouseMove = (e) => {
                if (!isResizing) return;
                const mainPanelRect = DOM.mainPanel.getBoundingClientRect();
                const newTerminalHeight = Math.max(40, Math.min(mainPanelRect.height - 100, mainPanelRect.bottom - e.clientY));
                DOM.terminalContainer.style.height = `${newTerminalHeight}px`;
            };
            
            const handleMouseUp = () => {
                isResizing = false;
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
                resizeComponents();
            };
            
            DOM.resizerHorizontal.addEventListener('mousedown', (e) => {
                e.preventDefault();
                isResizing = true;
                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);
            });
        }

        // Event Listeners Setup
        function setupEventListeners() {
            document.addEventListener('click', handleGlobalClick);
            DOM.filePanel.addEventListener('contextmenu', handleFileTreeContextMenu);
            document.addEventListener('keydown', handleGlobalKeydown);
            window.addEventListener('resize', resizeComponents);
        }

        function handleGlobalClick(e) {
            if (!DOM.contextMenu.contains(e.target)) {
                DOM.contextMenu.style.display = 'none';
            }
        }

        function handleFileTreeContextMenu(e) {
            e.preventDefault();
            const targetItem = e.target.closest('.tree-item');
            showContextMenu(e, targetItem);
        }

        function handleGlobalKeydown(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 's') { 
                e.preventDefault(); 
                saveCurrentFile(); 
            }
        }

        function resizeComponents() {
            editor.resize();
            if (fitAddon) fitAddon.fit();
        }

        // Terminal Functions
        function connectTerminalSocket() {
            socket = io('/terminal');
            
            socket.on('connect', () => {
                terminal.write('\r\n\x1b[32m✔\x1b[0m Terminal connected.\r\n$ ');
            });
            
            socket.on('output', (data) => {
                terminal.write(data);
            });
            
            socket.on('disconnect', () => {
                terminal.write('\r\n\x1b[31m✖\x1b[0m Terminal disconnected.\r\n');
            });
            
            terminal.onData((data) => {
                if (socket?.connected) {
                    socket.emit('input', data);
                }
            });
        }

        function toggleTerminal() {
            DOM.mainPanel.classList.toggle('terminal-hidden');
            setTimeout(resizeComponents, 10);
        }

        function clearTerminal() {
            if (terminal) {
                terminal.clear();
                showNotification('Terminal đã được xóa', 'success');
            }
        }

        function copyFromTerminal() {
            if (!terminal?.hasSelection()) {
                showNotification('Vui lòng chọn text trước khi copy', 'info');
                return;
            }
            
            navigator.clipboard.writeText(terminal.getSelection())
                .then(() => showNotification('Đã copy vào clipboard!', 'success'))
                .catch(() => showNotification('Copy thất bại. Vui lòng sử dụng Ctrl+Shift+C', 'error'));
        }

        function pasteToTerminal() {
            if (!terminal || !socket?.connected) return;
            
            navigator.clipboard.readText()
                .then(text => text && socket.emit('input', text))
                .catch(() => showNotification('Paste thất bại. Quyền truy cập có thể bị từ chối.', 'error'));
        }

        function scrollToTop() {
            terminal?.scrollToTop();
        }

        function scrollToBottom() {
            terminal?.scrollToBottom();
        }

        function showTerminalContextMenu(e) {
            const menuItems = [
                { text: 'Copy', icon: 'fa-copy', action: copyFromTerminal },
                { text: 'Paste', icon: 'fa-paste', action: pasteToTerminal },
                { separator: true },
                { text: 'Clear', icon: 'fa-ban', action: clearTerminal },
                { text: 'Scroll to Top', icon: 'fa-arrow-up', action: scrollToTop },
                { text: 'Scroll to Bottom', icon: 'fa-arrow-down', action: scrollToBottom }
            ];
            
            showContextMenuFromItems(e, menuItems);
        }

        // API Functions
        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetch(endpoint, options);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                if (data.error) throw new Error(data.error);
                return data;
            } catch (error) {
                showNotification(`API Error: ${error.message}`, 'error');
                throw error;
            }
        }

        // Notification System
        function showNotification(message, type = 'success') {
            const alertType = type === 'error' ? 'danger' : (type === 'info' ? 'primary' : 'success');
            const toast = document.createElement('div');
            toast.className = `toast show align-items-center text-bg-${alertType} border-0`;
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" onclick="this.parentElement.parentElement.remove()"></button>
                </div>
            `;
            DOM.toastContainer.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        // File Management
        function getFileIcon(filename) {
            const ext = filename.split('.').pop()?.toLowerCase() || '';
            const iconClass = CONFIG.fileIcons[ext] || 'fa-solid fa-file-lines';
            return { 
                icon: iconClass.startsWith('fa-') ? `fa-brands ${iconClass}` : iconClass, 
                color: '' 
            };
        }

        async function refreshRootFiles() {
            DOM.fileTreeRoot.innerHTML = '<div style="padding: 8px; color: #888;"><i>Đang tải...</i></div>';
            DOM.refreshIcon.classList.add('fa-spin');
            
            try {
                await loadFolderContents('.', DOM.fileTreeRoot);
            } finally {
                DOM.refreshIcon.classList.remove('fa-spin');
            }
        }

        async function loadFolderContents(path, parentElement) {
            try {
                const data = await apiCall(`/user/${username}/files`, {
                    method: "POST", 
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({ path: path })
                });
                
                parentElement.innerHTML = '';
                
                if (data.files?.length > 0) {
                    data.files.forEach(item => {
                        parentElement.appendChild(createTreeItem(item, path));
                    });
                } else if (path !== '.') {
                    parentElement.innerHTML = '<li style="padding-left: 20px; color: #888; font-style: italic;">(trống)</li>';
                }
            } catch (e) {
                parentElement.innerHTML = `<div style="padding: 8px; color: #f85149;"><i>Không thể tải files.</i></div>`;
            }
        }

        function createTreeItem(item, parentPath) {
            const li = document.createElement('li');
            const fullPath = parentPath === '.' ? item.name : `${parentPath}/${item.name}`;
            const itemDiv = document.createElement('div');
            
            itemDiv.className = `tree-item ${item.is_dir ? 'is-folder' : 'is-file'}`;
            itemDiv.dataset.path = fullPath;
            
            const iconData = item.is_dir ? 
                { icon: 'fa-solid fa-folder', color: '#58a6ff'} : 
                getFileIcon(item.name);
            
            itemDiv.innerHTML = `
                <div class="tree-chevron">
                    <i class="fa-solid fa-chevron-right fa-xs"></i>
                </div>
                <div class="tree-icon">
                    <i class="${iconData.icon}" style="color: ${iconData.color || 'inherit'}"></i>
                </div>
                <span class="tree-name">${item.name}</span>
            `;
            
            if (!item.is_dir) {
                itemDiv.querySelector('.tree-chevron').style.visibility = 'hidden';
            }
            
            li.appendChild(itemDiv);
            
            itemDiv.addEventListener('click', () => {
                selectTreeItem(itemDiv);
                item.is_dir ? toggleFolder(li) : openFile(fullPath, item.name);
            });
            
            return li;
        }

        function selectTreeItem(itemDiv) {
            if (selectedTreeItem) {
                selectedTreeItem.classList.remove('is-selected');
            }
            selectedTreeItem = itemDiv;
            itemDiv.classList.add('is-selected');
        }

        function toggleFolder(liElement) {
            const isOpen = liElement.classList.toggle('is-open');
            const itemDiv = liElement.querySelector('.tree-item');
            itemDiv.classList.toggle('is-open');
            
            if (isOpen) {
                let childUl = liElement.querySelector('ul');
                if (!childUl) {
                    childUl = document.createElement('ul');
                    liElement.appendChild(childUl);
                }
                loadFolderContents(itemDiv.dataset.path, childUl);
            }
        }
        
        async function createNewItem(type, parentPath = '.') {
            const itemName = type === 'folder' ? 'thư mục' : 'file';
            const name = prompt(`Nhập tên ${itemName} mới:`);
            if (!name?.trim()) return;
            
            const url = type === 'folder' ? 
                `/user/${username}/create-folder` : 
                `/user/${username}/editor/save`;
            
            const body = type === 'folder' ? 
                { folder_name: name, path: parentPath } : 
                { filename: name, path: parentPath, content: '' };
            
            try {
                await apiCall(url, { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify(body) 
                });
                
                showNotification(`Đã tạo ${itemName} '${name}' thành công!`, 'success');
                await refreshFileTree(parentPath);
            } catch (error) {
                showNotification(`Không thể tạo ${itemName} '${name}'`, 'error');
            }
        }

        async function refreshFileTree(parentPath) {
            if (parentPath === '.') {
                refreshRootFiles();
            } else {
                const parentFolderLi = document.querySelector(`.tree-item[data-path="${parentPath}"]`)?.parentElement;
                if (parentFolderLi?.classList.contains('is-open')) {
                    const childUl = parentFolderLi.querySelector('ul');
                    if (childUl) await loadFolderContents(parentPath, childUl);
                } else {
                    refreshRootFiles();
                }
            }
        }

        // Context Menu Functions
        function showContextMenu(e, targetItem) {
            const menuItems = createContextMenuItems(targetItem);
            showContextMenuFromItems(e, menuItems);
        }

        function createContextMenuItems(targetItem) {
            const path = targetItem?.dataset.path;
            const isFolder = targetItem?.classList.contains('is-folder');
            const menuItems = [];

            if (isFolder) {
                menuItems.push(
                    { text: 'Tạo File', icon: 'fa-file-plus', action: () => createNewItem('file', path) },
                    { text: 'Tạo Thư mục', icon: 'fa-folder-plus', action: () => createNewItem('folder', path) },
                    { text: 'Upload Files', icon: 'fa-upload', action: () => handleUploadClick(path) }
                );
            } else if (!targetItem) {
                menuItems.push(
                    { text: 'Tạo File', icon: 'fa-file-plus', action: () => createNewItem('file') },
                    { text: 'Tạo Thư mục', icon: 'fa-folder-plus', action: () => createNewItem('folder') },
                    { text: 'Upload Files', icon: 'fa-upload', action: () => handleUploadClick('.') }
                );
            }

            if (targetItem) {
                menuItems.push(
                    { separator: true },
                    { text: 'Đổi tên', icon: 'fa-i-cursor', action: () => handleRenameItem(path) },
                    { text: 'Xóa', icon: 'fa-trash', action: () => handleDeleteItem(path), isDanger: true }
                );
            }

            return menuItems;
        }

        function showContextMenuFromItems(e, menuItems) {
            DOM.contextMenu.innerHTML = '';
            
            menuItems.forEach(item => {
                if (item.separator) {
                    const separator = document.createElement('div');
                    separator.className = 'context-menu-separator';
                    DOM.contextMenu.appendChild(separator);
                } else {
                    const button = createContextMenuItem(item);
                    DOM.contextMenu.appendChild(button);
                }
            });
            
            DOM.contextMenu.style.left = `${e.clientX}px`;
            DOM.contextMenu.style.top = `${e.clientY}px`;
            DOM.contextMenu.style.display = 'block';
        }

        function createContextMenuItem({ text, icon, action, isDanger = false }) {
            const button = document.createElement('button');
            button.className = `context-menu-item ${isDanger ? 'danger' : ''}`;
            button.innerHTML = `<i class="context-menu-icon fa-solid ${icon}"></i> ${text}`;
            button.onclick = (event) => {
                event.stopPropagation();
                DOM.contextMenu.style.display = 'none';
                action();
            };
            return button;
        }

        async function handleRenameItem(oldPath) {
            const oldName = oldPath.split('/').pop();
            const newName = prompt('Nhập tên mới:', oldName);
            if (!newName?.trim() || newName === oldName) return;
            
            try {
                await apiCall(`/user/${username}/rename-item`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ old_path: oldPath, new_name: newName })
                });
                
                showNotification(`Đã đổi tên thành '${newName}'`, 'success');
                refreshRootFiles();
            } catch (error) {
                showNotification('Không thể đổi tên', 'error');
            }
        }
        
        async function handleDeleteItem(path) {
            const itemName = path.split('/').pop();
            if (!confirm(`Bạn có chắc muốn xóa "${itemName}"? Thao tác này không thể hoàn tác.`)) return;
            
            try {
                await apiCall(`/user/${username}/delete-item`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ path: path })
                });
                
                if (openFiles.has(path)) {
                    closeTab({ stopPropagation: () => {} }, path, true);
                }
                
                showNotification(`Đã xóa '${itemName}'`, 'success');
                refreshRootFiles();
            } catch (error) {
                showNotification('Không thể xóa', 'error');
            }
        }

        // File Upload Functions
        function handleUploadClick(path = '.') {
            uploadPath = path;
            DOM.fileUploadInput.click();
        }

        async function handleFileUpload(files) {
            if (files.length === 0) return;
            
            const formData = new FormData();
            Array.from(files).forEach(file => formData.append('files', file));
            formData.append('path', uploadPath);
            
            showNotification(`Đang upload ${files.length} file(s)...`, 'info');
            
            try {
                await apiCall(`/user/${username}/upload-files`, { 
                    method: 'POST', 
                    body: formData 
                });
                
                showNotification(`Đã upload ${files.length} file(s) thành công!`, 'success');
                await refreshFileTree(uploadPath);
            } catch (error) {
                showNotification('Upload thất bại', 'error');
            } finally {
                DOM.fileUploadInput.value = '';
            }
        }
        
        // File Editor Functions
        function openWelcomeTab() { 
            const content = `// Chào mừng đến với CodeSpace IDE!\n// Tính năng:\n// - Terminal hỗ trợ đầy đủ với copy/paste\n// - Terminal có thể cuộn với chuột\n// - Menu chuột phải\n// - Quản lý file\n// - Biên dịch và nạp Arduino/ESP\n\nconsole.log("Chúc bạn code vui vẻ!");`; 
            openFiles.set('Welcome', { 
                content, 
                saved: true, 
                shortName: 'Welcome', 
                path: '.' 
            }); 
            switchToFile('Welcome'); 
        }

        async function openFile(fullPath, shortName) { 
            if (openFiles.has(fullPath)) { 
                switchToFile(fullPath); 
                return; 
            } 
            
            const parentPath = fullPath.includes('/') ? 
                fullPath.split('/').slice(0, -1).join('/') : '.'; 
            
            try { 
                const data = await apiCall(`/user/${username}/editor/load`, { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({ filename: shortName, path: parentPath }) 
                }); 
                
                openFiles.set(fullPath, { 
                    content: data.content, 
                    saved: true, 
                    shortName, 
                    path: parentPath 
                }); 
                
                switchToFile(fullPath); 
            } catch (error) {
                showNotification(`Không thể mở file '${shortName}'`, 'error');
            } 
        }

        function switchToFile(fullPathKey) { 
            if (!openFiles.has(fullPathKey)) return; 
            
            currentFile = fullPathKey; 
            const fileData = openFiles.get(fullPathKey); 
            
            editor.setValue(fileData.content, -1); 
            
            const modelist = ace.require("ace/ext/modelist"); 
            editor.session.setMode(modelist.getModeForPath(fileData.shortName).mode); 
            editor.focus(); 
            
            renderTabs(); 
        }

        function renderTabs() { 
            DOM.editorTabs.innerHTML = ''; 
            
            for (const [key, data] of openFiles.entries()) { 
                const tab = createEditorTab(key, data);
                DOM.editorTabs.appendChild(tab); 
            } 
            
            updateSaveButtonState();
        }

        function createEditorTab(key, data) {
            const tab = document.createElement('button');
            tab.className = `editor-tab ${key === currentFile ? 'active' : ''}`;
            tab.title = key;
            tab.innerHTML = `<span>${data.shortName}${data.saved ? '' : ' •'}</span>`;
            tab.onclick = () => switchToFile(key);
            
            if (key !== 'Welcome') {
                const closeIcon = document.createElement('i');
                closeIcon.className = 'fa-solid fa-times close-icon';
                closeIcon.onclick = (e) => closeTab(e, key);
                tab.appendChild(closeIcon);
            }
            
            return tab;
        }

        function updateSaveButtonState() {
            const currentFileData = currentFile ? openFiles.get(currentFile) : null;
            DOM.saveButton.textContent = (currentFileData?.saved === false) ? 'Save*' : 'Save';
        }

        function updateTabAppearance(fullPathKey) { 
            const tabEl = Array.from(DOM.editorTabs.children).find(t => t.title === fullPathKey); 
            if (tabEl && openFiles.has(fullPathKey)) { 
                const fileData = openFiles.get(fullPathKey); 
                tabEl.querySelector('span').textContent = fileData.shortName + (fileData.saved ? '' : ' •'); 
            } 
        }

        function closeTab(e, fullPathKey, force = false) { 
            e.stopPropagation(); 
            
            const fileData = openFiles.get(fullPathKey); 
            if (!force && fileData && !fileData.saved) {
                if (!confirm('Bạn có thay đổi chưa lưu. Vẫn muốn đóng?')) return;
            }
            
            openFiles.delete(fullPathKey); 
            
            if (currentFile === fullPathKey) { 
                currentFile = Array.from(openFiles.keys()).pop() || null; 
                currentFile ? switchToFile(currentFile) : openWelcomeTab(); 
            } else { 
                renderTabs(); 
            } 
        }
        
        async function saveCurrentFile() { 
            if (!currentFile || currentFile === 'Welcome') return; 
            
            const fileData = openFiles.get(currentFile); 
            if (!fileData || fileData.saved) return; 
            
            const content = editor.getValue(); 
            
            try { 
                await apiCall(`/user/${username}/editor/save`, { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({ 
                        filename: fileData.shortName, 
                        content: content, 
                        path: fileData.path 
                    }) 
                }); 
                
                fileData.content = content; 
                fileData.saved = true; 
                updateTabAppearance(currentFile); 
                updateSaveButtonState();
                showNotification(`Đã lưu '${fileData.shortName}'`, 'success'); 
            } catch (error) {
                showNotification('Không thể lưu file', 'error');
            } 
        }

        // Compilation Functions
        async function compileCode(event) {
            if (!validateCompileConditions()) return;

            const { boardFqbn, sketchPath } = getCompileParams();
            const compileBtn = event.currentTarget;
            
            setButtonState(compileBtn, true, '<i class="fas fa-spinner fa-spin"></i> Đang biên dịch...');
            writeTerminalMessage(`\r\n\x1b[1;33m[COMPILE]\x1b[0m Đang biên dịch '${sketchPath}' cho ${boardFqbn}...\r\n`);

            try {
                const data = await apiCall(`/user/${username}/compile`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ sketch_path: sketchPath, board_fqbn: boardFqbn })
                });
                
                handleCompileResult(data);
            } catch (error) {
                handleCompileError(error);
            } finally {
                setButtonState(compileBtn, false, '<i class="fa-solid fa-cogs"></i><span>Biên dịch</span>');
                writeTerminalMessage('\r\n$ ');
            }
        }

        async function uploadCode(event) {
            if (!validateUploadConditions()) return;

            const { boardFqbn, sketchPath } = getCompileParams();
            const uploadBtn = event.currentTarget;
            
            setButtonState(uploadBtn, true, '<i class="fas fa-spinner fa-spin"></i> Đang nạp...');
            writeTerminalMessage(`\r\n\x1b[1;36m[UPLOAD]\x1b[0m Đang nạp '${sketchPath}' lên ${boardFqbn}...\r\n`);

            try {
                const data = await apiCall(`/user/${username}/upload`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ sketch_path: sketchPath, board_fqbn: boardFqbn })
                });
                
                handleUploadResult(data);
            } catch (error) {
                handleUploadError(error);
            } finally {
                setButtonState(uploadBtn, false, '<i class="fa-solid fa-upload"></i><span>Nạp code</span>');
                writeTerminalMessage('\r\n$ ');
            }
        }

        function validateCompileConditions() {
            if (!currentFile || currentFile === 'Welcome') {
                showNotification('Vui lòng mở một file .ino để biên dịch!', 'error');
                return false;
            }
            if (!currentFile.toLowerCase().endsWith('.ino')) {
                showNotification('Chỉ có thể biên dịch file .ino (Arduino sketch)!', 'error');
                return false;
            }
            return true;
        }

        function validateUploadConditions() {
            if (!currentFile || currentFile === 'Welcome') {
                showNotification('Vui lòng mở một file .ino để nạp!', 'error');
                return false;
            }
            if (!currentFile.toLowerCase().endsWith('.ino')) {
                showNotification('Chỉ có thể nạp file .ino (Arduino sketch)!', 'error');
                return false;
            }
            return true;
        }

        function getCompileParams() {
            const boardSelector = document.getElementById('boardSelector');
            return {
                boardFqbn: boardSelector.value,
                sketchPath: currentFile
            };
        }

        function setButtonState(button, disabled, html) {
            button.disabled = disabled;
            button.innerHTML = html;
        }

        function writeTerminalMessage(message) {
            terminal.write(message);
        }

        function handleCompileResult(data) {
            if (data.success) {
                writeTerminalMessage(`\x1b[1;32m✓ Biên dịch thành công!\x1b[0m\r\n`);
                writeTerminalMessage(`\x1b[90m${data.output}\x1b[0m\r\n`);
                showNotification('Biên dịch thành công!', 'success');
                displayCompileSuccess(data);
            } else {
                displayCompileErrors(data);
            }
            terminal.scrollToBottom();
        }

        function handleUploadResult(data) {
            if (data.success) {
                writeTerminalMessage(`\x1b[1;32m✓ Nạp code thành công!\x1b[0m\r\n`);
                writeTerminalMessage(`\x1b[90m${data.output}\x1b[0m\r\n`);
                showNotification('Nạp code thành công!', 'success');
            } else {
                displayUploadErrors(data);
            }
            terminal.scrollToBottom();
        }

        function handleCompileError(error) {
            writeTerminalMessage(`\x1b[1;31m✗ Lỗi hệ thống: ${error.message}\x1b[0m\r\n`);
            showNotification('Lỗi hệ thống khi biên dịch!', 'error');
        }

        function handleUploadError(error) {
            writeTerminalMessage(`\x1b[1;31m✗ Lỗi hệ thống: ${error.message}\x1b[0m\r\n`);
            showNotification('Lỗi hệ thống khi nạp code!', 'error');
        }

        function displayCompileErrors(data) {
            writeTerminalMessage(`\x1b[1;31m✗ Biên dịch thất bại!\x1b[0m\r\n`);
            displayErrorsInTerminal(data.error_analysis);
            
            const errorCount = data.error_analysis?.error_count || 0;
            const warningCount = data.error_analysis?.warning_count || 0;
            showNotification(`Biên dịch thất bại! ${errorCount} lỗi, ${warningCount} cảnh báo`, 'error');
            
            // Display in compile output container
            displayCompileError(data);
        }

        function displayUploadErrors(data) {
            writeTerminalMessage(`\x1b[1;31m✗ Nạp code thất bại!\x1b[0m\r\n`);
            writeTerminalMessage(`\x1b[90m${data.output || data.error}\x1b[0m\r\n`);
            showNotification('Nạp code thất bại!', 'error');
        }

        function displayErrorsInTerminal(errorAnalysis) {
            if (!errorAnalysis) return;
            
            if (errorAnalysis.errors?.length > 0) {
                writeTerminalMessage(`\x1b[1;31m━━━ ${errorAnalysis.error_count} LỖI CẦN SỬA ━━━\x1b[0m\r\n`);
                errorAnalysis.errors.forEach((error, index) => {
                    writeTerminalMessage(`\x1b[31m${index + 1}.\x1b[0m \x1b[36m${error.file}:${error.line}:${error.column}\x1b[0m\r\n`);
                    writeTerminalMessage(`   \x1b[91m${error.message}\x1b[0m\r\n\r\n`);
                });
            }
            
            if (errorAnalysis.warnings?.length > 0) {
                writeTerminalMessage(`\x1b[1;33m━━━ ${errorAnalysis.warning_count} CẢNH BÁO ━━━\x1b[0m\r\n`);
                errorAnalysis.warnings.forEach((warning, index) => {
                    writeTerminalMessage(`\x1b[33m${index + 1}.\x1b[0m \x1b[36m${warning.file}:${warning.line}:${warning.column}\x1b[0m\r\n`);
                    writeTerminalMessage(`   \x1b[93m${warning.message}\x1b[0m\r\n\r\n`);
                });
            }
        }

        // Compile output display functions
        function displayCompileSuccess(data) {
            const container = document.getElementById('compile-output-container');
            if (!container) return;
            
            container.innerHTML = '';
            const compileDiv = document.createElement('div');
            compileDiv.className = 'compile-output compile-result success';
            compileDiv.innerHTML = `
                <div class="result-header success">
                    <i class="fas fa-check-circle"></i>
                    <span>Biên dịch thành công!</span>
                </div>
                <div class="raw-output"><pre>${escapeHtml(data.output)}</pre></div>
            `;
            container.appendChild(compileDiv);
        }

        function displayCompileError(data) {
            const container = document.getElementById('compile-output-container');
            if (!container) return;
            
            container.innerHTML = '';
            const compileDiv = document.createElement('div');
            compileDiv.className = 'compile-output compile-result error';
            
            let html = `
                <div class="result-header error">
                    <i class="fas fa-times-circle"></i>
                    <span>Biên dịch thất bại!</span>
                </div>
            `;
            
            if (data.error_analysis && (data.error_analysis.errors?.length > 0 || data.error_analysis.warnings?.length > 0)) {
                html += createErrorAnalysisHTML(data.error_analysis);
            }
            
            html += `
                <button class="toggle-btn" onclick="toggleRawOutput(this)">
                    <i class="fas fa-eye"></i> Hiển thị log chi tiết
                </button>
                <div class="raw-output" style="display: none;">
                    <pre>${escapeHtml(data.output)}</pre>
                </div>
            `;
            
            compileDiv.innerHTML = html;
            container.appendChild(compileDiv);
        }

        function createErrorAnalysisHTML(analysis) {
            let html = '<div class="error-analysis">';
            
            if (analysis.errors?.length > 0) {
                html += `<div class="errors-section">
                    <h4><i class="fas fa-exclamation-triangle"></i> ${analysis.error_count} Lỗi cần sửa:</h4>
                    <div class="error-list">`;
                
                analysis.errors.forEach((error, index) => {
                    html += `
                        <div class="error-item" onclick="jumpToError('${escapeHtml(error.file)}', ${error.line})">
                            <div class="error-info">
                                <span class="error-number">${index + 1}</span>
                                <span class="file-info">
                                    <i class="fas fa-file-code"></i> ${escapeHtml(error.file)}:${error.line}:${error.column}
                                </span>
                            </div>
                            <div class="error-message">${escapeHtml(error.message)}</div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
            }
            
            if (analysis.warnings?.length > 0) {
                html += `<div class="warnings-section">
                    <h4><i class="fas fa-exclamation-circle"></i> ${analysis.warning_count} Cảnh báo:</h4>
                    <div class="warning-list">`;
                
                analysis.warnings.forEach((warning, index) => {
                    html += `
                        <div class="warning-item" onclick="jumpToError('${escapeHtml(warning.file)}', ${warning.line})">
                            <div class="warning-info">
                                <span class="warning-number">${index + 1}</span>
                                <span class="file-info">
                                    <i class="fas fa-file-code"></i> ${escapeHtml(warning.file)}:${warning.line}:${warning.column}
                                </span>
                            </div>
                            <div class="warning-message">${escapeHtml(warning.message)}</div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
            }
            
            html += '</div>';
            return html;
        }

        function toggleRawOutput(button) {
            const rawOutput = button.nextElementSibling;
            const isHidden = rawOutput.style.display === 'none';
            
            rawOutput.style.display = isHidden ? 'block' : 'none';
            button.innerHTML = isHidden ? 
                '<i class="fas fa-eye-slash"></i> Ẩn log chi tiết' : 
                '<i class="fas fa-eye"></i> Hiển thị log chi tiết';
        }

        function jumpToError(filename, lineNumber) {
            const targetFile = Array.from(openFiles.entries())
                .find(([key, data]) => data.shortName === filename)?.[0];
            
            if (targetFile) {
                switchToFile(targetFile);
                setTimeout(() => {
                    if (editor?.gotoLine) {
                        editor.gotoLine(lineNumber, 0, true);
                        editor.focus();
                    }
                }, 100);
                showNotification(`Nhảy đến dòng ${lineNumber} trong ${filename}`, 'info');
            } else {
                showNotification(`Không tìm thấy file ${filename} đang mở. Vui lòng mở file để xem lỗi.`, 'error');
            }
        }
        
        // Utility Functions
        function escapeHtml(text) {
            if (typeof text !== 'string') return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Search functionality
        function searchInFiles(query) {
            if (!query.trim()) return;
            
            writeTerminalMessage(`\r\n\x1b[1;34m[SEARCH]\x1b[0m Tìm kiếm "${query}" trong tất cả files...\r\n`);
            
            // Implementation would go here for searching through files
            // This would typically involve backend API call
        }

        // Auto-save functionality
        let autoSaveTimer = null;
        function scheduleAutoSave() {
            if (autoSaveTimer) clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(() => {
                if (currentFile && currentFile !== 'Welcome') {
                    const fileData = openFiles.get(currentFile);
                    if (fileData && !fileData.saved) {
                        saveCurrentFile();
                    }
                }
            }, 5000); // Auto-save after 5 seconds of inactivity
        }

        // Enhanced editor change handler with auto-save
        function handleEditorChangeWithAutoSave() {
            handleEditorChange();
            scheduleAutoSave();
        }

        // Theme switching
        function switchTheme(themeName) {
            const themes = {
                dark: "ace/theme/tomorrow_night_eighties",
                light: "ace/theme/textmate",
                monokai: "ace/theme/monokai",
                github: "ace/theme/github"
            };
            
            if (themes[themeName]) {
                editor.setTheme(themes[themeName]);
                showNotification(`Đã chuyển sang theme ${themeName}`, 'success');
            }
        }

        // Font size adjustment
        function adjustFontSize(delta) {
            const currentSize = editor.getFontSize();
            const newSize = Math.max(10, Math.min(24, currentSize + delta));
            editor.setFontSize(newSize);
            showNotification(`Cỡ chữ: ${newSize}px`, 'info');
        }

        // Error handling improvements
        function handleNetworkError(error) {
            console.error('Network error:', error);
            showNotification('Lỗi kết nối mạng. Vui lòng kiểm tra kết nối internet.', 'error');
        }

        // Socket connection management
        function reconnectSocket() {
            if (socket) {
                socket.disconnect();
            }
            connectTerminalSocket();
        }

        // Keyboard shortcuts
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Ctrl+S for save (already implemented)
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    saveCurrentFile();
                    return;
                }
                
                // Ctrl+N for new file
                if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                    e.preventDefault();
                    createNewItem('file');
                    return;
                }
                
                // Ctrl+O for open file (refresh file tree)
                if ((e.ctrlKey || e.metaKey) && e.key === 'o') {
                    e.preventDefault();
                    refreshRootFiles();
                    return;
                }
                
                // Ctrl+` for toggle terminal
                if ((e.ctrlKey || e.metaKey) && e.key === '`') {
                    e.preventDefault();
                    toggleTerminal();
                    return;
                }
                
                // Ctrl+F5 for compile
                if (e.ctrlKey && e.key === 'F5') {
                    e.preventDefault();
                    const compileBtn = document.querySelector('.btn-success');
                    if (compileBtn) compileCode({ currentTarget: compileBtn });
                    return;
                }
                
                // Font size shortcuts
                if ((e.ctrlKey || e.metaKey) && e.key === '=') {
                    e.preventDefault();
                    adjustFontSize(1);
                    return;
                }
                
                if ((e.ctrlKey || e.metaKey) && e.key === '-') {
                    e.preventDefault();
                    adjustFontSize(-1);
                    return;
                }
            });
        }

        // Initialize keyboard shortcuts
        document.addEventListener('DOMContentLoaded', () => {
            setupKeyboardShortcuts();
        });

        // Window beforeunload handler to warn about unsaved changes
        window.addEventListener('beforeunload', (e) => {
            const hasUnsavedChanges = Array.from(openFiles.values()).some(file => !file.saved);
            if (hasUnsavedChanges) {
                e.preventDefault();
                e.returnValue = 'Bạn có thay đổi chưa lưu. Bạn có chắc muốn rời khỏi trang?';
                return e.returnValue;
            }
        });

        // Error boundary for JavaScript errors
        window.addEventListener('error', (e) => {
            console.error('JavaScript error:', e.error);
            showNotification('Đã xảy ra lỗi JavaScript. Vui lòng refresh trang.', 'error');
        });

        // Performance monitoring
        function monitorPerformance() {
            const observer = new PerformanceObserver((list) => {
                for (const entry of list.getEntries()) {
                    if (entry.entryType === 'measure' && entry.duration > 100) {
                        console.warn(`Slow operation: ${entry.name} took ${entry.duration}ms`);
                    }
                }
            });
            
            observer.observe({ entryTypes: ['measure'] });
        }

        // Initialize performance monitoring
        if (typeof PerformanceObserver !== 'undefined') {
            monitorPerformance();
        }

        // Service worker registration for offline functionality
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(registration => {
                    console.log('ServiceWorker registered:', registration);
                })
                .catch(error => {
                    console.log('ServiceWorker registration failed:', error);
                });
        }

        // Additional IDE features
        function formatCode() {
            if (!currentFile || currentFile === 'Welcome') return;
            
            // Basic code formatting for Arduino/C++
            const content = editor.getValue();
            const lines = content.split('\n');
            let indentLevel = 0;
            const indentSize = 2;
            
            const formattedLines = lines.map(line => {
                const trimmed = line.trim();
                if (!trimmed) return '';
                
                // Decrease indent for closing braces
                if (trimmed.startsWith('}')) {
                    indentLevel = Math.max(0, indentLevel - 1);
                }
                
                const formatted = ' '.repeat(indentLevel * indentSize) + trimmed;
                
                // Increase indent for opening braces
                if (trimmed.endsWith('{')) {
                    indentLevel++;
                }
                
                return formatted;
            });
            
            editor.setValue(formattedLines.join('\n'), -1);
            showNotification('Đã format code', 'success');
        }

        function duplicateLine() {
            const cursor = editor.getCursorPosition();
            const line = editor.session.getLine(cursor.row);
            editor.session.insert({row: cursor.row + 1, column: 0}, line + '\n');
            showNotification('Đã duplicate dòng', 'info');
        }

        function commentToggle() {
            const range = editor.getSelectionRange();
            const selectedText = editor.getSelectedText();
            
            if (selectedText) {
                // Toggle block comment
                if (selectedText.startsWith('/*') && selectedText.endsWith('*/')) {
                    const uncommented = selectedText.slice(2, -2);
                    editor.session.replace(range, uncommented);
                } else {
                    editor.session.replace(range, `/*${selectedText}*/`);
                }
            } else {
                // Toggle line comment
                const cursor = editor.getCursorPosition();
                const line = editor.session.getLine(cursor.row);
                const trimmed = line.trim();
                
                if (trimmed.startsWith('//')) {
                    const uncommented = line.replace(/^\s*\/\/\s?/, '');
                    editor.session.replace({
                        start: {row: cursor.row, column: 0},
                        end: {row: cursor.row, column: line.length}
                    }, uncommented);
                } else {
                    const indentMatch = line.match(/^(\s*)/);
                    const indent = indentMatch ? indentMatch[1] : '';
                    const commented = indent + '// ' + line.slice(indent.length);
                    editor.session.replace({
                        start: {row: cursor.row, column: 0},
                        end: {row: cursor.row, column: line.length}
                    }, commented);
                }
            }
        }

        // Add more keyboard shortcuts for IDE functions
        function setupAdvancedKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Ctrl+/ for comment toggle
                if ((e.ctrlKey || e.metaKey) && e.key === '/') {
                    e.preventDefault();
                    commentToggle();
                    return;
                }
                
                // Ctrl+D for duplicate line
                if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
                    e.preventDefault();
                    duplicateLine();
                    return;
                }
                
                // Ctrl+Shift+F for format code
                if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'F') {
                    e.preventDefault();
                    formatCode();
                    return;
                }
                
                // F5 for compile
                if (e.key === 'F5') {
                    e.preventDefault();
                    const compileBtn = document.querySelector('.btn-success');
                    if (compileBtn) compileCode({ currentTarget: compileBtn });
                    return;
                }
                
                // Shift+F5 for upload
                if (e.shiftKey && e.key === 'F5') {
                    e.preventDefault();
                    const uploadBtn = document.querySelector('.btn-upload');
                    if (uploadBtn) uploadCode({ currentTarget: uploadBtn });
                    return;
                }
            });
        }

        // Initialize advanced shortcuts
        document.addEventListener('DOMContentLoaded', () => {
            setupAdvancedKeyboardShortcuts();
        });

        // File content preview
        function previewFile(path, filename) {
            const ext = filename.split('.').pop()?.toLowerCase();
            const textExtensions = ['txt', 'md', 'json', 'xml', 'log', 'ini', 'cfg'];
            
            if (textExtensions.includes(ext)) {
                // Could implement a preview modal here
                console.log(`Preview for ${filename} would show here`);
            }
        }

        // Status bar (could be added to show current file info, cursor position, etc.)
        function updateStatusBar() {
            if (!editor || !currentFile) return;
            
            const cursor = editor.getCursorPosition();
            const selection = editor.getSelectedText();
            const totalLines = editor.session.getLength();
            
            // Status info that could be displayed
            const statusInfo = {
                file: currentFile,
                line: cursor.row + 1,
                column: cursor.column + 1,
                totalLines: totalLines,
                selectedChars: selection.length
            };
            
            // Could update a status bar element if it existed
            console.log('Status:', statusInfo);
        }

        // Enhanced editor setup with status updates
        function setupEditorWithStatus() {
            setupEditor();
            
            editor.on('changeSelection', updateStatusBar);
            editor.on('changeCursor', updateStatusBar);
        }

        // Project settings
        const projectSettings = {
            defaultBoard: 'arduino:avr:uno',
            autoSave: true,
            fontSize: 14,
            theme: 'dark',
            tabSize: 2
        };

        function saveProjectSettings() {
            // In a real implementation, this would save to backend
            console.log('Project settings saved:', projectSettings);
        }

        function loadProjectSettings() {
            // In a real implementation, this would load from backend
            const boardSelector = document.getElementById('boardSelector');
            if (boardSelector && projectSettings.defaultBoard) {
                boardSelector.value = projectSettings.defaultBoard;
            }
            
            if (projectSettings.fontSize && editor) {
                editor.setFontSize(projectSettings.fontSize);
            }
        }

        // Initialize project settings
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(loadProjectSettings, 100);
        });

        // Cleanup function for when page unloads
        function cleanup() {
            if (socket) {
                socket.disconnect();
            }
            if (autoSaveTimer) {
                clearTimeout(autoSaveTimer);
            }
        }

        window.addEventListener('beforeunload', cleanup);

        // Export functions for debugging/external access
        window.IDEDebug = {
            editor,
            terminal,
            openFiles,
            currentFile,
            CONFIG,
            DOM
        };

        // Console welcome message
        console.log('%cCodeSpace IDE initialized successfully!', 'color: #58a6ff; font-weight: bold;');
        console.log('Debug tools available at window.IDEDebug');
    </script>
{% endblock %}